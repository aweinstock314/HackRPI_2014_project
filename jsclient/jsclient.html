<html>
<head>
<title>HackRPI 2014 project (TODO: naming)</title>
<script>
Object.prototype.dictForEach = function(f) {
    for(var key in this) {
        if(this.hasOwnProperty(key)) {
            f(key, this[key]);
        }
    }
};

function log(x) {
    document.getElementById("debugging_log").textContent += x + "\n";
}

function unserializeTuple(obj) {
    var tup = new Array();
    obj.dictForEach(function(k, v) {
        var result = /_field([0-9]+)/.exec(k);
        if(result) { tup[result[1]|0] = v; };
    });
    return tup;
}

function makeInitialState() {
    var state = {};
    state.playerNumber = null;
    state.world = {};
    state.models = {};
    state.addObject = function(id, obj) {
        obj.pos = unserializeTuple(obj.pos);
        obj.ori = unserializeTuple(obj.ori);
        state.world[id | 0] = obj;
    };
    return state;
}

var state = makeInitialState();

function main() {
    var ws = new WebSocket("ws://localhost:51702");
    window.addEventListener("beforeunload", function(event) { ws.close(); });
    var handlers = {};
    handlers["ProvideModel"] = function(state, msg) {
        state.models[msg.fields[0]] = msg.fields[1];
    };
    handlers["SetPosition"] = function(state, msg) {
        state.world[msg.fields[0] | 0].pos = unserializeTuple(msg.fields[1]);
    };
    handlers["SetOrientation"] = function(state, msg) {
        state.world[msg.fields[0] | 0].ori = unserializeTuple(msg.fields[1]);
    };
    handlers["AddObject"] = function(state, msg) {
        state.addObject(msg.fields[0], msg.fields[1]);
    };
    handlers["RemoveObject"] = function(state, msg) {
        delete state.world[msg.fields[0] | 0];
    };
    handlers["SetPlayerNumber"] = function(state, msg) {
        state.playerNumber = msg.fields[0] | 0;
    };
    handlers["InitializeWorld"] = function(state, msg) {
        msg.fields[0].dictForEach(state.addObject);
    };
    function defaultHandler(state, msg) {
        log("Unknown command: " + msg.variant);
        log(JSON.stringify(msg));
    };
    ws.onmessage = function(event) {
        var msg = JSON.parse(event.data);
        (handlers[msg.variant] || defaultHandler)(state, msg);
    };
    ws.onopen = function(event) {
        ["Floor", "Sphere", "Cylinder", "Triprism", "Player"/*, "Bullet"*/].forEach(function(modelName) {
            ws.send(JSON.stringify({variant: "RequestModel", fields: [modelName]}));
        });
    }
}
</script>
</head>
<body onload="main();">
<canvas width="640" height="480"></canvas>
<br />
<pre id="debugging_log"></pre>
</body>
